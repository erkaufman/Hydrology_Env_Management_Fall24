---
title: "Appendix"
author: "Emma Kaufman, Mark Lamendola, and Sarah Sussman"
output:
  pdf_document: default
fig_caption: yes
---

```{r message=FALSE, warning=FALSE, include=FALSE}
# load packages
library(readxl)
library(dplyr)
library(tidyverse)
library(zoo)
library(ggplot2)
library(knitr)
library(tidyr)


# read in raw data
Greensboro_raw <- read_excel("Data/Hydrology_memo_2.xlsx", 
    sheet = "Greensboro_daily_precip_1980-pr", 
    col_types = c("date", "text", "numeric", 
        "numeric", "numeric"), na = "NaN")

Boone_raw <- read_excel("Data/Hydrology_memo_2.xlsx", 
    sheet = "Boone_daily_precip_1980-present", 
    col_types = c("date", "text", "numeric", 
        "numeric", "numeric"), na = "NaN")

Greenville_raw <- read_excel("Data/Hydrology_memo_2.xlsx", 
    sheet = "Greenville_daily_precip_1980-pr", 
    col_types = c("date", "text", "numeric", 
        "numeric", "numeric"), na = "NaN")

Boone_raw$`Area Weighted Mean Precipitation (mm per day)` <- 
  as.numeric(Boone_raw$`Area Weighted Mean Precipitation (mm per day)`)

Greensboro_raw$`Area Weighted Mean Precipitation (mm per day)` <- 
  as.numeric(Greensboro_raw$`Area Weighted Mean Precipitation (mm per day)`)

Greenville_raw$`Area Weighted Mean Precipitation (mm per day)` <- 
  as.numeric(Greenville_raw$`Area Weighted Mean Precipitation (mm per day)`)
```

### Data Source
The daily area weighted mean precipitation data used for these analyses came from USGS gauging stations in Boone, Greensboro, and Greenville. The HUC codes for each station are as follows:
-   Boone HUC 050500010201
-   Greensboro HUC 030300020105
-   Greenville 030201030403
We used these data to analyze whether precipitation characteristics have changed for the different college campuses located in each of these cities since the last major investment in infrastructure that wrapped up in 1999.

### Data Wrangling
We began our analysis by preparing the data to analyze different storm event durations, focusing on 24-hr and 72-hr storm events. To get estimates for 72-hr storm events we took a rolling sum across a 3 day window to get an estimated 72-hour storm event for each day. For 24-hr storm events we took a moving average of 24-hr data over a 7-day window to ensure each event being analyzed was statistically different from the others, which is an assumption of the Weibull recurrence interval calculation.

For the 24-hour data we then found monthly maximum 24 hour events for each month in each year of available data. The maximum 24-hour storm event for each month from 1980-1999 and 2000-2016 was then used to calculate recurrence intervals for 24-hour storm events pre- and post-2000.

For the 72-hour data we found monthly maximum 72 hour events for each month in each year. The maximum 72-hour storm event for each month from 1980-1999 and 2000-2016 was then used to calculate recurrence intervals for 72-hour storm events pre- and post-2000.

```{r message=FALSE, warning=FALSE, include=FALSE}
Boone_rolling_sum <- Boone_raw %>%
  # Remove NAs for leap year issues
  drop_na(`Area Weighted Mean Precipitation (mm per day)`) %>% 
  mutate(
    # Rolling sums
    rolling_48hr = rollapply(`Area Weighted Mean Precipitation (mm per day)`, 
                             width = 2, FUN = sum, fill = NA, align = 'right'),
    rolling_72hr = rollapply(`Area Weighted Mean Precipitation (mm per day)`,
                             width = 3, FUN = sum, fill = NA, align = 'right')
  )

Greensboro_rolling_sum <- Greensboro_raw %>%
  # Remove NAs for leap year issues
  drop_na(`Area Weighted Mean Precipitation (mm per day)`) %>% 
  mutate(
    # Rolling sums
    rolling_48hr = rollapply(`Area Weighted Mean Precipitation (mm per day)`, 
                             width = 2, FUN = sum, fill = NA, align = 'right'),
    rolling_72hr = rollapply(`Area Weighted Mean Precipitation (mm per day)`, 
                             width = 3, FUN = sum, fill = NA, align = 'right')
  )

Greenville_rolling_sum <- Greenville_raw %>% 
  # Remove NAs for leap year issues
  drop_na(`Area Weighted Mean Precipitation (mm per day)`) %>% 
  mutate(
    # Rolling sums
    rolling_48hr = rollapply(`Area Weighted Mean Precipitation (mm per day)`,
                             width = 2, FUN = sum, fill = NA, align = 'right'),
    rolling_72hr = rollapply(`Area Weighted Mean Precipitation (mm per day)`, 
                             width = 3, FUN = sum, fill = NA, align = 'right')
  )
```

```{r message=FALSE, warning=FALSE, include=FALSE}
# Boone
# Take a moving average over a 7 day window
Boone_24hr <- Boone_raw %>%
  drop_na(`Area Weighted Mean Precipitation (mm per day)`) %>%
  mutate(weekly_avg_24hr_precip = rollmean(
    `Area Weighted Mean Precipitation (mm per day)`, 
    k = 7, #weekly rolling average
    fill = NA, 
    align = "right"))

# find monthly avg and max for 24 hour events
Boone_24hr_monthlyavg <- Boone_24hr %>% 
  slice(-1, -2, -3, -4, -5, -6) %>% #skip first three rows bc NA
  group_by(year,month) %>% 
  summarize(max_24_mm = max(weekly_avg_24hr_precip),
            avg_24_mm = mean(weekly_avg_24hr_precip)) %>% 
  mutate(Timeframe = as.factor(ifelse(year>=2000,"2000-2016","1980-1999")))


# Greensboro
# Take a moving average over a 7 day window
Greensboro_24hr <- Greensboro_raw %>%
  drop_na(`Area Weighted Mean Precipitation (mm per day)`) %>%
  mutate(weekly_avg_24hr_precip = rollmean(
    `Area Weighted Mean Precipitation (mm per day)`,
    k = 7, 
    fill = NA, 
    align = "right"))

#find monthly avg and max for 24 hour events
Greensboro_24hr_monthlyavg <- Greensboro_24hr %>% 
  slice(-1, -2, -3, -4, -5, -6) %>% #skip first three rows bc NA
  group_by(year,month) %>% 
  summarize(max_24_mm = max(weekly_avg_24hr_precip),
            avg_24_mm = mean(weekly_avg_24hr_precip)) %>% 
  mutate(Timeframe = as.factor(ifelse(year>=2000,"2000-2016","1980-1999")))


# Greenville
# moving average over 7 day window
Greenville_24hr <- Greenville_raw %>%
  drop_na(`Area Weighted Mean Precipitation (mm per day)`) %>%
  mutate(weekly_avg_24hr_precip = rollmean(
    `Area Weighted Mean Precipitation (mm per day)`, 
    k = 7, 
    fill = NA, 
    align = "right"))

# find monthly avg and max for 24 hour events
Greenville_24hr_monthlyavg <- Greenville_24hr %>% 
  slice(-1, -2, -3, -4, -5, -6) %>% #skip first three rows bc NA
  group_by(year,month) %>% 
  summarize(max_24_mm = max(weekly_avg_24hr_precip),
            avg_24_mm = mean(weekly_avg_24hr_precip)) %>% 
  mutate(Timeframe = as.factor(ifelse(year>=2000,"2000-2016","1980-1999")))


```

### Recurrence Interval Calculation
We calculated both the Weibull and Hazen recurrence intervals for Boone, Greensboro, and Greenville's monthly maximum 24-hour and 72-hour storm events from 1980-1999 and from 2000-2016. Recurrence intervals using each method differed due to Weibull being more conservative (assigning higher return periods for more extreme events), and Hazen being less conservative (assigning a smoother distribution of recurrence intervals). Due to the large sample size and wanting to have conservative estimates based on the application of using these return periods being used for flood mitigation, we moved forward with using Weibull return periods for our decision making process.

```{r message=FALSE, warning=FALSE, include=FALSE}
# Rank events and calculate return periods
# Boone
Boone_recurrence_24hr <- Boone_24hr_monthlyavg %>% 
  group_by(Timeframe) %>% 
  arrange(desc(max_24_mm)) %>% 
  mutate(
    Rank = rank(-max_24_mm),
    weibull_return_24hr = ((n()+1)/Rank),
    weibull_return_24_year = weibull_return_24hr/12,
    weibull_percent_likelihood=(1/weibull_return_24_year)*100*12,
    weibull_percent_likelihood_yr=(1/weibull_return_24_year)*100,
    hazen_percent_likelihood = 100*(2*Rank-1)/(2*n()),
    hazen_percent_likelihood_yr = 12*100*(2*Rank-1)/(2*n()),
    hazen_return_24hr = 100/hazen_percent_likelihood,
    hazen_return_24hr_year = hazen_return_24hr/12,
    log_prob_occurence_hazen = log(hazen_percent_likelihood_yr),
    log_prob_occurence_weibull = log(weibull_percent_likelihood_yr)
  )

# Greensboro
Greensboro_recurrence_24hr <- Greensboro_24hr_monthlyavg %>% 
  group_by(Timeframe) %>% 
  arrange(desc(max_24_mm)) %>% 
  mutate(
    Rank = rank(-max_24_mm),
    weibull_return_24hr = ((n()+1)/Rank),
    weibull_return_24_year = weibull_return_24hr/12,
    weibull_percent_likelihood=(1/weibull_return_24_year)*100*12,
    weibull_percent_likelihood_yr=(1/weibull_return_24_year)*100,
    hazen_percent_likelihood = 100*(2*Rank-1)/(2*n()),
    hazen_percent_likelihood_yr = 12*100*(2*Rank-1)/(2*n()),
    hazen_return_24hr = 100/hazen_percent_likelihood,
    hazen_return_24hr_year = hazen_return_24hr/12,
    log_prob_occurence_hazen = log(hazen_percent_likelihood_yr),
    log_prob_occurence_weibull = log(weibull_percent_likelihood_yr)
  )

# Greenville
Greenville_recurrence_24hr <- Greenville_24hr_monthlyavg %>% 
  group_by(Timeframe) %>% 
  arrange(desc(max_24_mm)) %>% 
  mutate(
    Rank = rank(-max_24_mm),
    weibull_return_24hr = ((n()+1)/Rank),
    weibull_return_24_year = weibull_return_24hr/12,
    weibull_percent_likelihood=(1/weibull_return_24_year)*100*12,
    weibull_percent_likelihood_yr=(1/weibull_return_24_year)*100,
    hazen_percent_likelihood = 100*(2*Rank-1)/(2*n()),
    hazen_percent_likelihood_yr = 12*100*(2*Rank-1)/(2*n()),
    hazen_return_24hr = 100/hazen_percent_likelihood,
    hazen_return_24hr_year = hazen_return_24hr/12,
    log_prob_occurence_hazen = log(hazen_percent_likelihood_yr),
    log_prob_occurence_weibull = log(weibull_percent_likelihood_yr)
  )

```

```{r message=FALSE, warning=FALSE, include=FALSE}
# Boone
#Take the maximum 72hr event for each month across all years
Boone_72hr_monthlyavg <- Boone_rolling_sum %>% 
  slice(-1, -2) %>% #skip first two rows bc NA
  group_by(year,month) %>% 
  summarize(max_72hr_mm = max(rolling_72hr),
            avg_72hr_mm = mean(rolling_72hr)) %>% 
  mutate(Timeframe = as.factor(ifelse(year>=2000,"2000-2016","1980-1999")))

#calculate recurrence intervals for each monthly maximum event across all years
Boone_72hr_recurrence<- Boone_72hr_monthlyavg %>% 
  group_by(Timeframe) %>% 
  arrange(desc(max_72hr_mm)) %>% 
  mutate(
    Rank = rank(-max_72hr_mm),
    weibull_return_72hr = ((n()+1)/Rank),
    weibull_return_72_year = weibull_return_72hr/12,
    weibull_percent_likelihood=(1/weibull_return_72_year)*100*12,
    weibull_percent_likelihood_yr=(1/weibull_return_72_year)*100,
    hazen_percent_likelihood = 100*(2*Rank-1)/(2*n()),
    hazen_percent_likelihood_yr = 12*100*(2*Rank-1)/(2*n()),
    hazen_return_72hr = 100/hazen_percent_likelihood,
    hazen_return_72hr_year = hazen_return_72hr/12,
    log_prob_occurence_hazen = log(hazen_percent_likelihood_yr),
    log_prob_occurence_weibull = log(weibull_percent_likelihood_yr)
  )

# Greensboro
Greensboro_72hr_monthlyavg <- Greensboro_rolling_sum %>% 
  slice(-1, -2) %>% #skip first two rows bc NA
  group_by(year,month) %>% 
  summarize(max_72hr_mm = max(rolling_72hr),
            avg_72hr_mm = mean(rolling_72hr)) %>% 
  mutate(Timeframe = as.factor(ifelse(year>=2000,"2000-2016","1980-1999")))

#calculate recurrence intervals for each monthly maximum event across all years
Greensboro_72hr_recurrence<- Greensboro_72hr_monthlyavg %>% 
  group_by(Timeframe) %>% 
  arrange(desc(max_72hr_mm)) %>% 
  mutate(
    Rank = rank(-max_72hr_mm),
    weibull_return_72hr = ((n()+1)/Rank),
    weibull_return_72_year = weibull_return_72hr/12,
    weibull_percent_likelihood=(1/weibull_return_72_year)*100*12,
    weibull_percent_likelihood_yr=(1/weibull_return_72_year)*100,
    hazen_percent_likelihood = 100*(2*Rank-1)/(2*n()),
    hazen_percent_likelihood_yr = 12*100*(2*Rank-1)/(2*n()),
    hazen_return_72hr = 100/hazen_percent_likelihood,
    hazen_return_72hr_year = hazen_return_72hr/12,
    log_prob_occurence_hazen = log(hazen_percent_likelihood_yr),
    log_prob_occurence_weibull = log(weibull_percent_likelihood_yr)
  )

# Greenville
Greenville_72hr_monthlyavg <- Greenville_rolling_sum %>% 
  slice(-1, -2) %>% #skip first two rows bc NA
  group_by(year,month) %>% 
  summarize(max_72hr_mm = max(rolling_72hr),
            avg_72hr_mm = mean(rolling_72hr)) %>% 
  mutate(Timeframe = as.factor(ifelse(year>=2000,"2000-2016","1980-1999")))

#calculate recurrence intervals for each monthly maximum event across all years
Greenville_72hr_recurrence<- Greenville_72hr_monthlyavg %>% 
  group_by(Timeframe) %>% 
  arrange(desc(max_72hr_mm)) %>% 
  mutate(
    Rank = rank(-max_72hr_mm),
    weibull_return_72hr = ((n()+1)/Rank),
    weibull_return_72_year = weibull_return_72hr/12,
    weibull_percent_likelihood=(1/weibull_return_72_year)*100*12,
    weibull_percent_likelihood_yr=(1/weibull_return_72_year)*100,
    hazen_percent_likelihood = 100*(2*Rank-1)/(2*n()),
    hazen_percent_likelihood_yr = 12*100*(2*Rank-1)/(2*n()),
    hazen_return_72hr = 100/hazen_percent_likelihood,
    hazen_return_72hr_year = hazen_return_72hr/12,
    log_prob_occurence_hazen = log(hazen_percent_likelihood_yr),
    log_prob_occurence_weibull = log(weibull_percent_likelihood_yr)
  )
```

After calculating return intervals for each 24-hour and 72-hour storm event in each time frame of interest (pre- and post-2000) we plotted the difference in return periods from 1980-1999 and from 2000-2016 for each city.

Since 1980-1999, events of the same likelihood have become more intense. For example, in Boone, a 1 inch 24-hour event from 1980-1999 had a 37.5% chance of occurring. More recent data (2000-2016) shows that the same likelihood event would be associated with around a 1.25 inch 24 hour event. More rain in the same amount of time is more likely now than it was in 2000.



```{r echo=FALSE, message=FALSE, warning=FALSE, fig.cap= "Boone 24-hr storm events"}
# Boone

Boone_24hr_plot_weibull <- Boone_recurrence_24hr %>%
  ggplot(aes(x = weibull_percent_likelihood_yr, 
             y = max_24_mm/25.4, 
             color = Timeframe)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Probability of Occurrence (%)", 
       y = "Maximum 24-Hour Precipitation (in)", 
       title = "Monthly maximum 24-hour storm recurrence intervals",
       subtitle = "Boone, NC",
       color = NULL) +
  theme_minimal() +
  scale_color_manual(values = c("thistle4", "tomato3"))+
  scale_x_log10(
    trans = "reverse",  
    limits = c(100, 1),  
    breaks = c(100, 50, 25, 10, 5, 1),  
    labels = c(100, 50, 25, 10, 5, 1)
  )+ 
  theme(legend.position = "top")

Boone_24hr_plot_weibull
```


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.cap= "Greensboro 24-hr storm events"}
Greensboro_24hr_plot_weibull <- Greensboro_recurrence_24hr %>%
  ggplot(aes(x = weibull_percent_likelihood_yr, 
             y = max_24_mm/25.4, 
             color = Timeframe)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Probability of Occurrence (%)", 
       y = "Maximum 24-Hour Precipitation (in)", 
       title = "Monthly maximum 24-hour storm recurrence intervals",
       subtitle = "Greensboro, NC",
       color = NULL) +
  theme_minimal() +
  scale_color_manual(values = c("thistle4", "tomato3"))+
  scale_x_log10(
    trans = "reverse",  
    limits = c(100, 1),  
    breaks = c(100, 50, 25, 10, 5, 1),  
    labels = c(100, 50, 25, 10, 5, 1)  
  )+ 
  theme(legend.position = "top")


Greensboro_24hr_plot_weibull
```


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.cap= "Greenville 24-hr storm events"}
Greenville_24hr_plot_weibull <- Greenville_recurrence_24hr %>%
  ggplot(aes(x = weibull_percent_likelihood_yr, 
             y = max_24_mm/25.4, 
             color = Timeframe)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Probability of Occurrence (%)", 
       y = "Maximum 24-Hour Precipitation (in)", 
       title = "Monthly maximum 24-hour storm recurrence intervals",
       subtitle = "Greenville, NC",
       color = NULL) +
  theme_minimal() +
  scale_color_manual(values = c("thistle4", "tomato3"))+
  scale_x_log10(
    trans = "reverse",  
    limits = c(100, 1),  
    breaks = c(100, 50, 25, 10, 5, 1),  
    labels = c(100, 50, 25, 10, 5, 1)  
  )+ 
  theme(legend.position = "top")


Greenville_24hr_plot_weibull
```


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.cap= "Boone 72-hr storm events"}
# Boone
Boone_72hr_plot_weibull <- Boone_72hr_recurrence %>%
  ggplot(aes(x = weibull_percent_likelihood_yr, 
             y = max_72hr_mm/25.4, 
             color = Timeframe)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Probability of Occurrence (%)", 
       y = "Maximum 72-Hour Precipitation (in)", 
       title = "Monthly maximum 72-hour storm recurrence intervals",
       subtitle = "Boone, NC",
       color = NULL) +
  theme_minimal() +
  scale_color_manual(values = c("thistle4", "tomato3"))+
  scale_x_log10(
    trans = "reverse",  
    limits = c(100, 1),  
    breaks = c(100, 50, 25, 10, 5, 1),  
    labels = c(100, 50, 25, 10, 5, 1)  
  )+ 
  theme(legend.position = "top")

Boone_72hr_plot_weibull

```


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.cap= "Greensboro 72-hr storm events"}
# Greensboro
Greensboro_72hr_plot_weibull <- Greensboro_72hr_recurrence %>%
  ggplot(aes(x = weibull_percent_likelihood_yr, 
             y = max_72hr_mm/25.4, 
             color = Timeframe)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Probability of Occurrence (%)", 
       y = "Maximum 72-Hour Precipitation (in)", 
       title = "Monthly maximum 72-hour storm recurrence intervals",
       subtitle = "Greensboro, NC",
       color = NULL) +
  theme_minimal() +
  scale_color_manual(values = c("thistle4", "tomato3"))+
  scale_x_log10(
    trans = "reverse",  # Reverse the log10 x-axis
    limits = c(100, 1),  # Set the x-axis limits from 100 to 1
    breaks = c(100, 50, 25, 10, 5, 1),  # Custom breaks
    labels = c(100, 50, 25, 10, 5, 1)  # Custom labels for breaks
  )+ 
  theme(legend.position = "top")

Greensboro_72hr_plot_weibull

```


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.cap= "Greenville 72-hr storm events"}
# Greenville
Greenville_72hr_plot_weibull <- Greenville_72hr_recurrence %>%
   ggplot(aes(x = weibull_percent_likelihood_yr, 
             y = max_72hr_mm/25.4, 
             color = Timeframe)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Probability of Occurrence (%)", 
       y = "Maximum 72-Hour Precipitation (in)", 
       title = "Monthly maximum 72-hour storm recurrence intervals",
       subtitle = "Greenville, NC",
       color = NULL) +
  theme_minimal() +
  scale_color_manual(values = c("thistle4", "tomato3"))+
  scale_x_log10(
    trans = "reverse",  # Reverse the log10 x-axis
    limits = c(100, 1),  # Set the x-axis limits from 100 to 1
    breaks = c(100, 50, 25, 10, 5, 1),  # Custom breaks
    labels = c(100, 50, 25, 10, 5, 1)  # Custom labels for breaks
  )+ 
  theme(legend.position = "top")

Greenville_72hr_plot_weibull

```


The lines of best fit on each of the above graphs represent the probability distributions of different intensity 24-hr and 72-hr storm events (range on y-axis) in 1980-1999 and 2000-2016. We used these probability distributions to extract the depth of precipitation for 10, 25, 50, and 100 year flood events for 24-hr and 72-hr events in each city for the two time periods, as seen in the tables below:


Table: Precipitation frequency estimates (in) for Boone, NC - 1980-1999

|Duration | 10 Year Flood| 25 Year Flood| 50 Year Flood| 100 Year Flood|
 |:--------|-------------:|-------------:|-------------:|--------------:|
 |24-hr    |          1.20|           1.4|          1.54|           1.69|
 |72-hr    |          6.94|           8.1|          8.98|           9.87|


 Table: Precipitation frequency estimates (in) for Boone, NC - 2000-2016

 |Duration | 10 Year Flood| 25 Year Flood| 50 Year Flood| 100 Year Flood|
 |:--------|-------------:|-------------:|-------------:|--------------:|
 |24-hr    |          1.46|          1.70|          1.89|           2.08|
 |72-hr    |          7.44|          8.71|          9.66|          10.62|


 Table: Precipitation frequency estimates (in) for Greensboro, NC - 1980-1999

 |Duration | 10 Year Flood| 25 Year Flood| 50 Year Flood| 100 Year Flood|
 |:--------|-------------:|-------------:|-------------:|--------------:|
 |24-hr    |          0.96|          1.12|          1.23|           1.35|
 |72-hr    |          5.41|          6.30|          6.98|           7.66|


 Table: Precipitation frequency estimates (in) for Greensboro, NC - 2000-2016

 |Duration | 10 Year Flood| 25 Year Flood| 50 Year Flood| 100 Year Flood|
 |:--------|-------------:|-------------:|-------------:|--------------:|
 |24-hr    |          1.08|          1.25|          1.39|           1.52|
 |72-hr    |          5.56|          6.50|          7.20|           7.91|


 Table: Precipitation frequency estimates (in) for Greenville, NC - 1980-1999

 |Duration | 10 Year Flood| 25 Year Flood| 50 Year Flood| 100 Year Flood|
 |:--------|-------------:|-------------:|-------------:|--------------:|
 |24-hr    |           1.2|          1.40|          1.56|           1.71|
 |72-hr    |           6.5|          7.62|          8.46|           9.31|


 Table: Precipitation frequency estimates (in) for Greenville, NC - 2000-2016

 |Duration | 10 Year Flood| 25 Year Flood| 50 Year Flood| 100 Year Flood|
|:--------|-------------:|-------------:|-------------:|--------------:|
|24-hr    |          1.55|          1.82|          2.03|           2.24|
|72-hr    |          8.69|         10.27|         11.46|          12.66|

```{r message=FALSE, warning=FALSE, include=FALSE}
# weibull
# boone 24 hr event
# Define probabilities of occurrence
probabilities <- c(1, 2, 4, 10)

# Create an empty list to store results
results <- list()

# Step 1: Loop through each timeframe and fit models
for (tf in levels(Boone_recurrence_24hr$Timeframe)) {
  
  # Filter data for the current timeframe
  data_subset <- Boone_recurrence_24hr %>% 
    filter(Timeframe == tf)
  
  # Step 2: Fit a linear model
  model <- lm(max_24_mm ~ log_prob_occurence_weibull, data = data_subset)
  
  # Step 3: Create a new data frame for predictions
  new_data <- data.frame(log_prob_occurence_weibull = log(probabilities))
  
  # Step 4: Make predictions using the model
  predicted_precipitation <- predict(model, newdata = new_data)
  
  # Step 5: Combine the predictions with the corresponding prob. and timeframe
  predicted_results <- data.frame(
    Probability = probabilities,
    Timeframe = tf,
    Predicted_Precipitation_mm = predicted_precipitation,
    Predicted_Precipitation_in = round(predicted_precipitation/25.4, 2)
  )
  
  # Step 6: Store the results in the list
  results[[tf]] <- predicted_results
}

# Step 7: Combine all results into a single data frame
final_results_boone_24 <- bind_rows(results)

# Display the predicted precipitation for each timeframe
print(final_results_boone_24)

```

```{r message=FALSE, warning=FALSE, include=FALSE}
#weibull
# greensboro 24 hr event
# Define probabilities of occurrence
probabilities <- c(1, 2, 4, 10)

# Create an empty list to store results
results <- list()

# Step 1: Loop through each timeframe and fit models
for (tf in levels(Greensboro_recurrence_24hr$Timeframe)) {
  
  # Filter data for the current timeframe
  data_subset <- Greensboro_recurrence_24hr %>% 
    filter(Timeframe == tf)
  
  # Step 2: Fit a linear model
  model <- lm(max_24_mm ~ log_prob_occurence_weibull, data = data_subset)
  
  # Step 3: Create a new data frame for predictions
  new_data <- data.frame(log_prob_occurence_weibull = log(probabilities))
  
  # Step 4: Make predictions using the model
  predicted_precipitation <- predict(model, newdata = new_data)
  
  # Step 5: Combine the predictions with the corresponding probab. and timeframe
  predicted_results <- data.frame(
    Probability = probabilities,
    Timeframe = tf,
    Predicted_Precipitation_mm = predicted_precipitation,
    Predicted_Precipitation_in = round(predicted_precipitation/25.4, 2)
  )
  
  # Step 6: Store the results in the list
  results[[tf]] <- predicted_results
}

# Step 7: Combine all results into a single data frame
final_results_greensboro_24 <- bind_rows(results)

# Display the predicted precipitation for each timeframe
print(final_results_greensboro_24)

```

```{r message=FALSE, warning=FALSE, include=FALSE}
# weibull
# greenville 24 hr event
# Define probabilities of occurrence
probabilities <- c(1, 2, 4, 10)

# Create an empty list to store results
results <- list()

# Step 1: Loop through each timeframe and fit models
for (tf in levels(Greenville_recurrence_24hr$Timeframe)) {
  
  # Filter data for the current timeframe
  data_subset <-Greenville_recurrence_24hr %>% 
    filter(Timeframe == tf)
  
  # Step 2: Fit a linear model
  model <- lm(max_24_mm ~ log_prob_occurence_weibull, data = data_subset)
  
  # Step 3: Create a new data frame for predictions
  new_data <- data.frame(log_prob_occurence_weibull = log(probabilities))
  
  # Step 4: Make predictions using the model
  predicted_precipitation <- predict(model, newdata = new_data)
  
  # Step 5: Combine the predictions with the corresponding prob and timeframe
  predicted_results <- data.frame(
    Probability = probabilities,
    Timeframe = tf,
    Predicted_Precipitation_mm = predicted_precipitation,
    Predicted_Precipitation_in = round(predicted_precipitation/25.4, 2)
  )
  
  # Step 6: Store the results in the list
  results[[tf]] <- predicted_results
}

# Step 7: Combine all results into a single data frame
final_results_greenville_24 <- bind_rows(results)

# Display the predicted precipitation for each timeframe
print(final_results_greenville_24)

```

```{r message=FALSE, warning=FALSE, include=FALSE}
# weibull
# Boone 72 hr event
# Define probabilities of occurrence
probabilities <- c(1, 2, 4, 10)

# Create an empty list to store results
results <- list()

# Step 1: Loop through each timeframe and fit models
for (tf in levels(Boone_72hr_recurrence$Timeframe)) {
  
  # Filter data for the current timeframe
  data_subset <-Boone_72hr_recurrence %>% 
    filter(Timeframe == tf)
  
  # Step 2: Fit a linear model
  model <- lm(max_72hr_mm ~ log_prob_occurence_weibull, data = data_subset)
  
  # Step 3: Create a new data frame for predictions
  new_data <- data.frame(log_prob_occurence_weibull = log(probabilities))
  
  # Step 4: Make predictions using the model
  predicted_precipitation <- predict(model, newdata = new_data)
  
  # Step 5: Combine the predictions with the corresponding prob and timeframe
  predicted_results <- data.frame(
    Probability = probabilities,
    Timeframe = tf,
    Predicted_Precipitation_mm = predicted_precipitation,
    Predicted_Precipitation_in = round(predicted_precipitation/25.4, 2)
  )
  
  # Step 6: Store the results in the list
  results[[tf]] <- predicted_results
}

# Step 7: Combine all results into a single data frame
final_results_boone_72 <- bind_rows(results)

# Display the predicted precipitation for each timeframe
print(final_results_boone_72)
```

```{r message=FALSE, warning=FALSE, include=FALSE}
# weibull
# Greensboro 72 hr event
# Define probabilities of occurrence
probabilities <- c(1, 2, 4, 10)

# Create an empty list to store results
results <- list()

# Step 1: Loop through each timeframe and fit models
for (tf in levels(Greensboro_72hr_recurrence$Timeframe)) {
  
  # Filter data for the current timeframe
  data_subset <-Greensboro_72hr_recurrence %>% 
    filter(Timeframe == tf)
  
  # Step 2: Fit a linear model
  model <- lm(max_72hr_mm ~ log_prob_occurence_weibull, data = data_subset)
  
  # Step 3: Create a new data frame for predictions
  new_data <- data.frame(log_prob_occurence_weibull = log(probabilities))
  
  # Step 4: Make predictions using the model
  predicted_precipitation <- predict(model, newdata = new_data)
  
  # Step 5: Combine the predictions with the corresponding prob and timeframe
  predicted_results <- data.frame(
    Probability = probabilities,
    Timeframe = tf,
    Predicted_Precipitation_mm = predicted_precipitation,
    Predicted_Precipitation_in = round(predicted_precipitation/25.4, 2)
  )
  
  # Step 6: Store the results in the list
  results[[tf]] <- predicted_results
}

# Step 7: Combine all results into a single data frame
final_results_greensboro_72 <- bind_rows(results)

# Display the predicted precipitation for each timeframe
print(final_results_greensboro_72)
```

```{r message=FALSE, warning=FALSE, include=FALSE}
# weibull
# Greenville 72 hr event
# Define probabilities of occurrence
probabilities <- c(1, 2, 4, 10)

# Create an empty list to store results
results <- list()

# Step 1: Loop through each timeframe and fit models
for (tf in levels(Greenville_72hr_recurrence$Timeframe)) {
  
  # Filter data for the current timeframe
  data_subset <-Greenville_72hr_recurrence %>% 
    filter(Timeframe == tf)
  
  # Step 2: Fit a linear model
  model <- lm(max_72hr_mm ~ log_prob_occurence_weibull, data = data_subset)
  
  # Step 3: Create a new data frame for predictions
  new_data <- data.frame(log_prob_occurence_weibull = log(probabilities))
  
  # Step 4: Make predictions using the model
  predicted_precipitation <- predict(model, newdata = new_data)
  
  # Step 5: Combine the predictions with the corresponding prob and timeframe
  predicted_results <- data.frame(
    Probability = probabilities,
    Timeframe = tf,
    Predicted_Precipitation_mm = predicted_precipitation,
    Predicted_Precipitation_in = round(predicted_precipitation/25.4, 2)
  )
  
  # Step 6: Store the results in the list
  results[[tf]] <- predicted_results
}

# Step 7: Combine all results into a single data frame
final_results_greenville_72 <- bind_rows(results)

# Display the predicted precipitation for each timeframe
print(final_results_greenville_72)
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# Create table for each city
create_table_inches <- function(data_24, data_72, city_name) {
  # Create separate tables for each timeframe
  for (timeframe in unique(data_24$Timeframe)) {
    # Filter data for the current timeframe
    data_24_tf <- data_24 %>% filter(Timeframe == timeframe)
    data_72_tf <- data_72 %>% filter(Timeframe == timeframe)

    # Combine the data
    combined_data <- bind_rows(
      mutate(data_24_tf, Duration = "24-hr"),
      mutate(data_72_tf, Duration = "72-hr")
    ) %>%
      select(Duration, Probability, Predicted_Precipitation_in) %>%  
      pivot_wider(names_from = Probability, 
                  values_from = Predicted_Precipitation_in) %>%
      rename(
        `10 Year Flood` = `10`,  
        `25 Year Flood` = `4`,   
        `50 Year Flood` = `2`,   
        `100 Year Flood` = `1`   
      ) %>%
      select(Duration,
             `10 Year Flood`, 
             `25 Year Flood`, 
             `50 Year Flood`, 
             `100 Year Flood`)  # Reorder columns

    # Print the table with a title
    cat(paste("\nPrecipitation frequency estimates (in) for", 
              city_name, "-", timeframe, "\n"))
    print(kable(combined_data, 
                caption = paste(
                  "Precipitation frequency estimates (in) for",
                  city_name, "-", timeframe)))
  }
}

# Create tables for Boone
create_table_inches(final_results_boone_24, 
                    final_results_boone_72, "Boone, NC")

# Create tables for Greensboro
create_table_inches(final_results_greensboro_24,
                    final_results_greensboro_72, "Greensboro, NC")

# Create tables for Greenville
create_table_inches(final_results_greenville_24,
                    final_results_greenville_72, "Greenville, NC")


```

### Changes in flood events over time
After getting the precipitation frequency estimates for 24-hr and 72-hr events for 10 year, 25 year, 50 year, and 100 year return intervals, we examined what the maximum monthly 24-hr and 72-hr events were from 1980-1999 and from 2000-2016 in each city. The purpose of this was to see if 25 year flood events (what we are assuming the infrastructure was designed for at each campus in 1999) are becoming more frequent or changing seasons from hurricane (July-October) to frontal (January-June). We counted how many times the maximum 24-hr and 72-hr 25 year flood events were occurring in each month pre-2000 and post-2000. 


Table: Change in 25-year flood events pre-2000 and post-2000 for Boone, NC

| Season          | Event                   | 1980-1999 | 2000-2016 |
|:----------------|:------------------------|----------:|----------:|
| **Hurricane**   | 24-hr 25-year event      |      0     |   4        |
|                 | 72-hr 25-year event      |       0    |     1      |
| **Frontal**     | 24-hr 25-year event      |      0     |     0      |
|                 | 72-hr 25-year event      |       0    |       0    |

Table: Change in 25-year flood events pre-2000 and post-2000 for Greensboro, NC

| Season          | Event                   | 1980-1999 | 2000-2016 |
|:----------------|:------------------------|----------:|----------:|
| **Hurricane**   | 24-hr 25-year event      |      1     |   0        |
|                 | 72-hr 25-year event      |       1    |     1      |
| **Frontal**     | 24-hr 25-year event      |      0     |     0      |
|                 | 72-hr 25-year event      |       0    |       0    |

Table: Change in 25-year flood events pre-2000 and post-2000 for Greenville, NC

| Season          | Event                   | 1980-1999 | 2000-2016 |
|:----------------|:------------------------|----------:|----------:|
| **Hurricane**   | 24-hr 25-year event      |      1     |   5        |
|                 | 72-hr 25-year event      |       1    |     5      |
| **Frontal**     | 24-hr 25-year event      |      0     |     0      |
|                 | 72-hr 25-year event      |       0    |       0    |

```{r message=FALSE, warning=FALSE, include=FALSE}
#Boone 24 hr
prob_4_percent_value <- final_results_boone_24 %>%
  filter(Timeframe == '1980-1999', Probability == 4) %>%
  pull(Predicted_Precipitation_mm)

boone_monthly_new_data <- Boone_24hr_monthlyavg %>% 
  filter(Timeframe=='2000-2016') %>% 
  group_by(month) %>% 
  summarise(avg=mean(max_24_mm),
            max=max(max_24_mm),
            exceed_count = sum(max_24_mm > prob_4_percent_value)) %>% 
  
  ungroup()

boone_monthly_old_data <-  Boone_24hr_monthlyavg %>% 
  filter(Timeframe=='1980-1999') %>% 
  group_by(month) %>% 
  summarise(avg=mean(max_24_mm),
            max=max(max_24_mm),
            exceed_count = sum(max_24_mm > prob_4_percent_value)) %>% 
  ungroup()
```

```{r message=FALSE, warning=FALSE, include=FALSE}
#Greensboro 24 hr
prob_4_percent_value <- final_results_greensboro_24 %>%
  filter(Timeframe == '1980-1999', Probability == 4) %>%
  pull(Predicted_Precipitation_mm)

greensboro_monthly_new_data <- Greensboro_24hr_monthlyavg %>% 
  filter(Timeframe=='2000-2016') %>% 
  group_by(month) %>% 
  summarise(avg=mean(max_24_mm),
            max=max(max_24_mm),
            exceed_count = sum(max_24_mm > prob_4_percent_value)) %>% 
  
  ungroup()

greensboro_monthly_old_data <-  Greensboro_24hr_monthlyavg %>% 
  filter(Timeframe=='1980-1999') %>% 
  group_by(month) %>% 
  summarise(avg=mean(max_24_mm),
            max=max(max_24_mm),
            exceed_count = sum(max_24_mm > prob_4_percent_value)) %>% 
  ungroup()
```



```{r message=FALSE, warning=FALSE, include=FALSE}
#Greenville 24 hour events:
prob_4_percent_value <- final_results_greenville_24 %>%
  filter(Timeframe == '1980-1999', Probability == 4) %>%
  pull(Predicted_Precipitation_mm)

greenville_monthly_new_data <- Greenville_24hr_monthlyavg %>% 
  filter(Timeframe=='2000-2016') %>% 
  group_by(month) %>% 
  summarise(avg=mean(max_24_mm),
            max=max(max_24_mm),
            exceed_count = sum(max_24_mm > prob_4_percent_value)) %>% 
  
  ungroup()

greenville_monthly_old_data <-  Greenville_24hr_monthlyavg %>% 
  filter(Timeframe=='1980-1999') %>% 
  group_by(month) %>% 
  summarise(avg=mean(max_24_mm),
            max=max(max_24_mm),
            exceed_count = sum(max_24_mm > prob_4_percent_value)) %>% 
  ungroup()
```


```{r message=FALSE, warning=FALSE, include=FALSE}
#Boone 72 hour
prob_4_percent_value <- final_results_boone_72 %>%
  filter(Timeframe == '1980-1999', Probability == 4) %>%
  pull(Predicted_Precipitation_mm)

boone_monthly_new_data_72 <- Boone_72hr_monthlyavg %>% 
  filter(Timeframe=='2000-2016') %>% 
  group_by(month) %>% 
  summarise(avg=mean(max_72hr_mm),
            max=max(max_72hr_mm),
            exceed_count = sum(max_72hr_mm > prob_4_percent_value))  %>% 
  ungroup()

boone_monthly_old_data_72 <-  Boone_72hr_monthlyavg %>% 
  filter(Timeframe=='1980-1999') %>% 
  group_by(month) %>% 
  summarise(avg=mean(max_72hr_mm),
            max=max(max_72hr_mm),
            exceed_count = sum(max_72hr_mm > prob_4_percent_value)) %>% 
  ungroup()
```


```{r message=FALSE, warning=FALSE, include=FALSE}
# Greensboro 72hr storm events
prob_4_percent_value <- final_results_greensboro_72 %>%
  filter(Timeframe == '1980-1999', Probability == 4) %>%
  pull(Predicted_Precipitation_mm)

greensboro_monthly_new_data_72 <- Greensboro_72hr_monthlyavg %>% 
  filter(Timeframe=='2000-2016') %>% 
  group_by(month) %>% 
  summarise(avg=mean(max_72hr_mm),
            max=max(max_72hr_mm),
            exceed_count = sum(max_72hr_mm > prob_4_percent_value))  %>% 
  ungroup()

greensboro_monthly_old_data_72 <-  Greensboro_72hr_monthlyavg %>% 
  filter(Timeframe=='1980-1999') %>% 
  group_by(month) %>% 
  summarise(avg=mean(max_72hr_mm),
            max=max(max_72hr_mm),
            exceed_count = sum(max_72hr_mm > prob_4_percent_value)) %>% 
  ungroup()


```


```{r message=FALSE, warning=FALSE, include=FALSE}
# Greenville 72hr storm events
prob_4_percent_value <- final_results_greenville_72 %>%
  filter(Timeframe == '1980-1999', Probability == 4) %>%
  pull(Predicted_Precipitation_mm)

greenville_monthly_new_data_72 <- Greenville_72hr_monthlyavg %>% 
  filter(Timeframe=='2000-2016') %>% 
  group_by(month) %>% 
  summarise(avg=mean(max_72hr_mm),
            max=max(max_72hr_mm),
            exceed_count = sum(max_72hr_mm > prob_4_percent_value))  %>% 
  ungroup()

greenville_monthly_old_data_72 <-  Greenville_72hr_monthlyavg %>% 
  filter(Timeframe=='1980-1999') %>% 
  group_by(month) %>% 
  summarise(avg=mean(max_72hr_mm),
            max=max(max_72hr_mm),
            exceed_count = sum(max_72hr_mm > prob_4_percent_value)) %>% 
  ungroup()
```

25-year flood events during hurricane season have increased in frequency in Boone and Greenville since 2000. 25-year flood events in Greensboro have not increased in frequency. The results from Greensboro made us want to take a deeper dive into the data. We explored the raw data and found frequency of events greater than a 10 year flood event are happening at the same frequency in hurricane and frontal seasons pre- and post-2000 in Greensboro. Additionally, the average magnitude of these events is not increasing. 

```{r message=FALSE, warning=FALSE, include=FALSE}
greensboro_explore_hurricane_pre <- Greensboro_24hr %>% 
  filter(year< 2000 & year > 1984,
         `Area Weighted Mean Precipitation (mm per day)`> 24.4,
         month== c(7,8,9,10)) 

#frequency of events greater than 10 year floods is the same
#magnitude of those events is decreasing 
greensboro_explore_frontal_pre <-Greensboro_24hr %>% 
  filter(year< 2000,
         `Area Weighted Mean Precipitation (mm per day)`> 24.4,
         month== c(1,2,3,4,5,6))

greensboro_explore_hurricane_post <- Greensboro_24hr %>% 
  filter(year>= 2000,
         `Area Weighted Mean Precipitation (mm per day)`> 24.4,
         month== c(7,8,9,10)) 

greensboro_explore_frontal_post <-Greensboro_24hr %>% 
  filter(year>= 2000,
         `Area Weighted Mean Precipitation (mm per day)`> 24.4,
         month== c(1,2,3,4,5,6))
magnitude_hurricane_pre <- mean(greensboro_explore_hurricane_pre$`Area Weighted Mean Precipitation (mm per day)`)
magnitude_hurricane_pre
magnitude_hurricane_post <- mean(greensboro_explore_hurricane_post$`Area Weighted Mean Precipitation (mm per day)`)
magnitude_hurricane_post
magnitude_frontal_pre <- mean(greensboro_explore_frontal_pre$`Area Weighted Mean Precipitation (mm per day)`)
magnitude_frontal_pre
magnitude_frontal_post <- mean(greensboro_explore_frontal_post$`Area Weighted Mean Precipitation (mm per day)`)
magnitude_frontal_post
  
```

### Hours spent working
Emma Kaufman: 20 hours
Sarah Sussman: 13 hours
Mark Lamendola: 10 hours
